<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Swim Time Tracker</title>

<link href="https://api.fontshare.com/v2/css?f[]=general-sans@400,500,600&display=swap" rel="stylesheet">

<style>
    :root {
        --bg: #f5f1ea;
        --bg-soft: #fdfaf6;
        --card: #ffffff;
        --accent: #2f6fff;
        --accent-soft: rgba(47, 111, 255, 0.12);
        --accent-strong: #214dcc;
        --text-main: #1f2430;
        --text-soft: #6b7280;
        --border-soft: #e1d9cc;
        --danger: #e45858;
        --danger-soft: rgba(228, 88, 88, 0.12);
        --radius-lg: 18px;
        --radius-md: 12px;
        --radius-sm: 8px;
        --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.12);
        --shadow-subtle: 0 8px 20px rgba(15, 23, 42, 0.06);
        --transition-fast: 0.18s ease-out;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'General Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: radial-gradient(circle at top left, #fdf7ec 0, #f5f1ea 40%, #f0ece6 100%);
        color: var(--text-main);
    }

    header {
        padding: 18px 20px 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .brand-icon {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: linear-gradient(135deg, #2f6fff, #4dd0ff);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 18px;
        box-shadow: 0 10px 25px rgba(47, 111, 255, 0.35);
    }

    .brand-text h1 {
        margin: 0;
        font-size: 20px;
        letter-spacing: 0.02em;
    }

    .brand-text span {
        font-size: 12px;
        color: var(--text-soft);
    }

    .primary-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .pill {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent-strong);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .pill-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.18);
    }

    button {
        border: none;
        border-radius: 999px;
        padding: 9px 18px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast), opacity var(--transition-fast);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    button:active {
        transform: translateY(1px) scale(0.99);
        box-shadow: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2f6fff, #4dd0ff);
        color: white;
        box-shadow: 0 12px 30px rgba(47, 111, 255, 0.45);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2859d8, #3bb8eb);
    }

    .btn-ghost {
        background: transparent;
        color: var(--text-soft);
        padding-inline: 10px;
    }

    .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.7);
        color: var(--text-main);
    }

    .subtitle-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-inline: 4px;
        margin-top: 4px;
    }

    .subtitle-row span {
        font-size: 12px;
        color: var(--text-soft);
    }

    .autosave-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-soft);
    }

    .autosave-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
    }

    .autosave-indicator.saving .autosave-dot {
        animation: pulse 0.9s infinite alternate;
        background: #facc15;
    }

    @keyframes pulse {
        from { transform: scale(1); opacity: 0.7; }
        to { transform: scale(1.4); opacity: 1; }
    }

    .app-shell {
        padding: 10px 16px 24px;
    }

    .app-layout {
        max-width: 1120px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1.1fr);
        gap: 18px;
    }

    @media (max-width: 880px) {
        .app-layout {
            grid-template-columns: minmax(0, 1fr);
        }
    }

    .panel {
        background: var(--bg-soft);
        border-radius: var(--radius-lg);
        padding: 14px;
        box-shadow: var(--shadow-subtle);
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .panel-header h2 {
        margin: 0;
        font-size: 15px;
    }

    .panel-header span {
        font-size: 11px;
        color: var(--text-soft);
    }

    .tab-row {
        display: inline-flex;
        padding: 3px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
    }

    .tab-btn {
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-soft);
        background: transparent;
        cursor: pointer;
        border: none;
        transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .tab-btn.active {
        background: var(--accent);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(47, 111, 255, 0.45);
    }

    .tab-btn:hover:not(.active) {
        background: rgba(15, 23, 42, 0.04);
        color: var(--text-main);
    }

    .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }

    .chip {
        font-size: 11px;
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-soft);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .chip strong {
        color: var(--text-main);
    }

    select, input, textarea {
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        padding: 8px 10px;
        font-size: 13px;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.9);
        transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    select:focus, input:focus, textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(47, 111, 255, 0.25);
        background: #ffffff;
        transform: translateY(-1px);
    }

    #sortSelect, #filterEvent {
        min-width: 130px;
    }

    #entries {
        display: grid;
        gap: 10px;
        margin-top: 4px;
        max-height: 420px;
        overflow: auto;
        padding-right: 4px;
    }

    .entry {
        background: var(--card);
        border-radius: var(--radius-md);
        padding: 10px 12px;
        border: 1px solid rgba(225, 217, 204, 0.9);
        display: grid;
        grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.2fr);
        gap: 6px 10px;
        align-items: center;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
        position: relative;
        overflow: hidden;
    }

    @media (max-width: 640px) {
        .entry {
            grid-template-columns: minmax(0, 1fr);
        }
    }

    .entry::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(47, 111, 255, 0.04), transparent);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition-fast);
    }

    .entry:hover::before {
        opacity: 1;
    }

    .entry-main {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .entry-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
    }

    .entry-event {
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.04);
    }

    .entry-time {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent-strong);
    }

    .entry-meta {
        font-size: 11px;
        color: var(--text-soft);
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .entry-notes {
        font-size: 12px;
        color: var(--text-main);
        opacity: 0.8;
        margin-top: 2px;
    }

    .entry-actions {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        align-items: center;
    }

    .btn-mini {
        padding: 5px 10px;
        font-size: 11px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.03);
        color: var(--text-soft);
    }

    .btn-mini:hover {
        background: rgba(15, 23, 42, 0.06);
        color: var(--text-main);
    }

    .btn-mini-danger {
        background: var(--danger-soft);
        color: var(--danger);
    }

    .btn-mini-danger:hover {
        background: rgba(228, 88, 88, 0.18);
        color: #b91c1c;
    }

    .badge-best {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        background: #22c55e1a;
        color: #15803d;
        font-weight: 600;
    }

    .empty-state {
        font-size: 12px;
        color: var(--text-soft);
        padding: 18px 10px 6px;
        text-align: center;
    }

    .empty-state span {
        display: block;
        margin-top: 4px;
        font-size: 11px;
    }

    /* Right panel */

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        margin-top: 6px;
    }

    .stat-card {
        background: var(--card);
        border-radius: var(--radius-md);
        padding: 10px;
        border: 1px solid rgba(225, 217, 204, 0.9);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .stat-label {
        font-size: 11px;
        color: var(--text-soft);
    }

    .stat-value {
        font-size: 16px;
        font-weight: 700;
    }

    .stat-sub {
        font-size: 11px;
        color: var(--text-soft);
    }

    .settings-section {
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px dashed rgba(148, 132, 110, 0.5);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-soft);
    }

    .settings-row strong {
        color: var(--text-main);
        font-size: 12px;
    }

    .toggle {
        position: relative;
        width: 38px;
        height: 20px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.12);
        cursor: pointer;
        transition: background var(--transition-fast);
    }

    .toggle-thumb {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: white;
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
        transition: transform var(--transition-fast);
    }

    .toggle.on {
        background: var(--accent);
    }

    .toggle.on .toggle-thumb {
        transform: translateX(18px);
    }

    .note-small {
        font-size: 11px;
        color: var(--text-soft);
    }

    /* Modal */

    #entryForm {
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px;
        z-index: 20;
    }

    #entryForm.hidden {
        display: none;
    }

    .overlay {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.18), rgba(15, 23, 42, 0.55));
        backdrop-filter: blur(12px);
    }

    .form-card {
        position: relative;
        z-index: 1;
        background: linear-gradient(145deg, #fdfaf6, #f5f1ea);
        border-radius: 22px;
        padding: 18px 18px 14px;
        width: 100%;
        max-width: 360px;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(255, 255, 255, 0.9);
        animation: popIn 0.18s ease-out;
    }

    @keyframes popIn {
        from { transform: translateY(8px) scale(0.97); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
    }

    .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .form-header h2 {
        margin: 0;
        font-size: 16px;
    }

    .form-header span {
        font-size: 11px;
        color: var(--text-soft);
    }

    .form-grid {
        display: grid;
        gap: 8px;
        margin-top: 6px;
    }

    label {
        font-size: 12px;
        color: var(--text-soft);
        display: block;
        margin-bottom: 3px;
    }

    textarea {
        resize: vertical;
        min-height: 60px;
        max-height: 120px;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        gap: 8px;
    }

    .btn-secondary {
        background: rgba(15, 23, 42, 0.04);
        color: var(--text-soft);
    }

    .btn-secondary:hover {
        background: rgba(15, 23, 42, 0.08);
        color: var(--text-main);
    }

    .helper-text {
        font-size: 11px;
        color: var(--text-soft);
        margin-top: 4px;
    }

    .helper-text code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.04);
        padding: 2px 5px;
        border-radius: 999px;
    }

    .hidden-section {
        display: none;
    }

    .hidden-section.active {
        display: block;
    }
</style>
</head>

<body>

<header>
    <div class="top-bar">
        <div class="brand">
            <div class="brand-icon">S</div>
            <div class="brand-text">
                <h1>Swim Time Tracker</h1>
                <span>Keep track of personal bests, race history, and progress.</span>
            </div>
        </div>
        <div class="primary-actions">
            <div class="pill">
                <div class="pill-dot"></div>
                Autosave on this device
            </div>
            <button class="btn-primary" id="addEntryBtn">
                + Add Time
            </button>
        </div>
    </div>
    <div class="subtitle-row">
        <div class="autosave-indicator" id="autosaveIndicator">
            <div class="autosave-dot"></div>
            <span>Saved</span>
        </div>
    </div>
</header>

<div class="app-shell">
    <div class="app-layout">
        <!-- Left: Times -->
        <section class="panel">
            <div class="panel-header">
                <div>
                    <h2>Times</h2>
                    <span>View and organize all your swims.</span>
                </div>
                <div class="tab-row">
                    <button class="tab-btn active" data-tab="listTab">List</button>
                    <button class="tab-btn" data-tab="statsTab">Stats</button>
                </div>
            </div>

            <div id="listTab" class="tab-content">
                <div class="controls">
                    <select id="filterEvent">
                        <option value="all">All events</option>
                        <option>50 Free</option>
                        <option>100 Free</option>
                        <option>200 Free</option>
                        <option>500 Free</option>
                        <option>1000 Free</option>
                        <option>1650 Free</option>
                        <option>100 Back</option>
                        <option>200 Back</option>
                        <option>100 Breast</option>
                        <option>200 Breast</option>
                        <option>100 Fly</option>
                        <option>200 Fly</option>
                        <option>200 IM</option>
                        <option>400 IM</option>
                    </select>

                    <select id="sortSelect">
                        <option value="newest">Newest first</option>
                        <option value="oldest">Oldest first</option>
                        <option value="best">Best time</option>
                        <option value="event">Event name</option>
                    </select>

                    <div class="chip">
                        <strong id="countChip">0</strong> swims saved
                    </div>
                </div>

                <div id="entries"></div>
                <div class="empty-state" id="emptyState">
                    No swims yet.
                    <span>Tap <strong>“+ Add Time”</strong> to add your first swim.</span>
                </div>
            </div>

            <div id="statsTab" class="tab-content hidden-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total swims</div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-sub">All events combined</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Events tracked</div>
                        <div class="stat-value" id="statEvents">0</div>
                        <div class="stat-sub">Different race types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Most recent swim</div>
                        <div class="stat-value" id="statLastDate">—</div>
                        <div class="stat-sub" id="statLastEvent">No swims yet</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Best overall time</div>
                        <div class="stat-value" id="statBestTime">—</div>
                        <div class="stat-sub" id="statBestEvent">No swims yet</div>
                    </div>
                </div>
                <p class="helper-text" style="margin-top:10px;">
                    Stats update automatically whenever you add or remove a swim.
                </p>
            </div>
        </section>

        <!-- Right: Summary / Settings -->
        <section class="panel">
            <div class="panel-header">
                <div>
                    <h2>Summary & Settings</h2>
                    <span>Quick overview and device options.</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today</div>
                    <div class="stat-value" id="statTodayCount">0</div>
                    <div class="stat-sub">Swims logged today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This week</div>
                    <div class="stat-value" id="statWeekCount">0</div>
                    <div class="stat-sub">Swims in last 7 days</div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-row">
                    <div>
                        <strong>Compact cards</strong>
                        <div class="note-small">Show more swims on screen at once.</div>
                    </div>
                    <div class="toggle" id="toggleCompact">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>

                <div class="settings-row">
                    <div>
                        <strong>Backup file</strong>
                        <div class="note-small">Download a copy of your times to keep safe.</div>
                    </div>
                    <button class="btn-mini" id="backupBtn">Download backup</button>
                </div>

                <div class="settings-row">
                    <div>
                        <strong>Reset this device</strong>
                        <div class="note-small">Remove all saved times from this browser.</div>
                    </div>
                    <button class="btn-mini btn-mini-danger" id="clearBtn">Clear all</button>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Add Time Modal -->
<section id="entryForm" class="hidden">
    <div class="overlay"></div>
    <div class="form-card">
        <div class="form-header">
            <div>
                <h2>Add swim</h2>
                <span>Log a race or practice time.</span>
            </div>
            <button class="btn-secondary" id="cancelEntry">Close</button>
        </div>

        <div class="form-grid">
            <div>
                <label for="eventInput">Event</label>
                <select id="eventInput">
                    <option value="">Choose event</option>
                    <option>50 Free</option>
                    <option>100 Free</option>
                    <option>200 Free</option>
                    <option>500 Free</option>
                    <option>1000 Free</option>
                    <option>1650 Free</option>
                    <option>100 Back</option>
                    <option>200 Back</option>
                    <option>100 Breast</option>
                    <option>200 Breast</option>
                    <option>100 Fly</option>
                    <option>200 Fly</option>
                    <option>200 IM</option>
                    <option>400 IM</option>
                </select>
            </div>

            <div>
                <label for="timeInput">Time</label>
                <input id="timeInput" placeholder="01:02.34">
                <div class="helper-text">
                    Format: <code>MM:SS.ms</code> (minutes : seconds . hundredths)
                </div>
            </div>

            <div>
                <label for="dateInput">Date</label>
                <input id="dateInput" type="date">
            </div>

            <div>
                <label for="notesInput">Notes (optional)</label>
                <textarea id="notesInput" placeholder="Meet name, heat, lane, how it felt..."></textarea>
            </div>
        </div>

        <div class="form-actions">
            <div class="helper-text">
                Your swim is saved automatically when you press <strong>Save swim</strong>.
            </div>
            <button class="btn-primary" id="saveEntry">Save swim</button>
        </div>
    </div>
</section>

<script>
const STORAGE_KEY = "swimTimes_v2";

let entries = loadEntries();

const entriesDiv = document.getElementById("entries");
const addEntryBtn = document.getElementById("addEntryBtn");
const entryForm = document.getElementById("entryForm");
const saveEntry = document.getElementById("saveEntry");
const cancelEntry = document.getElementById("cancelEntry");
const sortSelect = document.getElementById("sortSelect");
const filterEvent = document.getElementById("filterEvent");
const clearBtn = document.getElementById("clearBtn");
const backupBtn = document.getElementById("backupBtn");
const countChip = document.getElementById("countChip");
const emptyState = document.getElementById("emptyState");
const autosaveIndicator = document.getElementById("autosaveIndicator");
const toggleCompact = document.getElementById("toggleCompact");

const statTotal = document.getElementById("statTotal");
const statEvents = document.getElementById("statEvents");
const statLastDate = document.getElementById("statLastDate");
const statLastEvent = document.getElementById("statLastEvent");
const statBestTime = document.getElementById("statBestTime");
const statBestEvent = document.getElementById("statBestEvent");
const statTodayCount = document.getElementById("statTodayCount");
const statWeekCount = document.getElementById("statWeekCount");

const tabButtons = document.querySelectorAll(".tab-btn");
const listTab = document.getElementById("listTab");
const statsTab = document.getElementById("statsTab");

function loadEntries() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
    } catch {
        return [];
    }
}

function saveEntries() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    showAutosave("Saved");
}

let autosaveTimeout;
function showAutosave(text) {
    autosaveIndicator.classList.add("saving");
    autosaveIndicator.querySelector("span").textContent = text || "Saving...";
    clearTimeout(autosaveTimeout);
    autosaveTimeout = setTimeout(() => {
        autosaveIndicator.classList.remove("saving");
        autosaveIndicator.querySelector("span").textContent = "Saved";
    }, 700);
}

function parseTimeToMs(t) {
    if (!t) return Infinity;
    const parts = t.split(":");
    if (parts.length !== 2) return Infinity;
    const [minStr, rest] = parts;
    const secParts = rest.split(".");
    if (secParts.length !== 2) return Infinity;
    const [secStr, msStr] = secParts;
    const min = Number(minStr);
    const sec = Number(secStr);
    const ms = Number(msStr);
    if (Number.isNaN(min) || Number.isNaN(sec) || Number.isNaN(ms)) return Infinity;
    return min * 60000 + sec * 1000 + ms;
}

function formatDateDisplay(dateStr) {
    if (!dateStr) return "No date";
    const d = new Date(dateStr + "T00:00:00");
    if (Number.isNaN(d.getTime())) return dateStr;
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
}

function isToday(dateStr) {
    if (!dateStr) return false;
    const d = new Date(dateStr + "T00:00:00");
    const now = new Date();
    return d.getFullYear() === now.getFullYear() &&
           d.getMonth() === now.getMonth() &&
           d.getDate() === now.getDate();
}

function isWithinLastDays(dateStr, days) {
    if (!dateStr) return false;
    const d = new Date(dateStr + "T00:00:00");
    const now = new Date();
    const diff = now - d;
    const limit = days * 24 * 60 * 60 * 1000;
    return diff >= 0 && diff <= limit;
}

function computeBestByEvent() {
    const best = {};
    for (const e of entries) {
        const key = e.event;
        const ms = parseTimeToMs(e.time);
        if (!best[key] || ms < best[key].ms) {
            best[key] = { ms, time: e.time };
        }
    }
    return best;
}

function render() {
    entriesDiv.innerHTML = "";

    let filtered = [...entries];

    if (filterEvent.value !== "all") {
        filtered = filtered.filter(e => e.event === filterEvent.value);
    }

    if (sortSelect.value === "best") {
        filtered.sort((a, b) => parseTimeToMs(a.time) - parseTimeToMs(b.time));
    } else if (sortSelect.value === "event") {
        filtered.sort((a, b) => a.event.localeCompare(b.event));
    } else if (sortSelect.value === "oldest") {
        filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
    } else {
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    const bestByEvent = computeBestByEvent();

    countChip.textContent = entries.length.toString();
    emptyState.style.display = filtered.length === 0 ? "block" : "none";

    filtered.forEach((e, index) => {
        const div = document.createElement("div");
        div.className = "entry";
        if (document.body.classList.contains("compact")) {
            div.style.padding = "8px 10px";
        }

        const isBestForEvent = bestByEvent[e.event] && bestByEvent[e.event].time === e.time;

        div.innerHTML = `
            <div class="entry-main">
                <div class="entry-header">
                    <div class="entry-event">${e.event}</div>
                    <div class="entry-time">${e.time}</div>
                    ${isBestForEvent ? `<span class="badge-best">Best for this event</span>` : ""}
                </div>
                <div class="entry-meta">
                    <span>${formatDateDisplay(e.date)}</span>
                    ${e.source ? `<span>Source: ${e.source}</span>` : ""}
                </div>
                ${e.notes ? `<div class="entry-notes">${e.notes}</div>` : ""}
            </div>
            <div class="entry-actions">
                <button class="btn-mini" data-edit="${index}">Edit</button>
                <button class="btn-mini btn-mini-danger" data-delete="${index}">Delete</button>
            </div>
        `;

        entriesDiv.appendChild(div);
    });

    updateStats();
}

function updateStats() {
    const total = entries.length;
    statTotal.textContent = total.toString();

    const eventsSet = new Set(entries.map(e => e.event));
    statEvents.textContent = eventsSet.size.toString();

    if (entries.length === 0) {
        statLastDate.textContent = "—";
        statLastEvent.textContent = "No swims yet";
        statBestTime.textContent = "—";
        statBestEvent.textContent = "No swims yet";
        statTodayCount.textContent = "0";
        statWeekCount.textContent = "0";
        return;
    }

    const sortedByDate = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));
    const last = sortedByDate[0];
    statLastDate.textContent = formatDateDisplay(last.date);
    statLastEvent.textContent = last.event || "—";

    const sortedByTime = [...entries].sort((a, b) => parseTimeToMs(a.time) - parseTimeToMs(b.time));
    const best = sortedByTime[0];
    if (parseTimeToMs(best.time) === Infinity) {
        statBestTime.textContent = "—";
        statBestEvent.textContent = "No valid times yet";
    } else {
        statBestTime.textContent = best.time;
        statBestEvent.textContent = best.event || "—";
    }

    const todayCount = entries.filter(e => isToday(e.date)).length;
    const weekCount = entries.filter(e => isWithinLastDays(e.date, 7)).length;
    statTodayCount.textContent = todayCount.toString();
    statWeekCount.textContent = weekCount.toString();
}

function openModal(editIndex = null) {
    entryForm.classList.remove("hidden");
    document.body.style.overflow = "hidden";

    const eventInput = document.getElementById("eventInput");
    const timeInput = document.getElementById("timeInput");
    const dateInput = document.getElementById("dateInput");
    const notesInput = document.getElementById("notesInput");

    if (editIndex !== null) {
        const e = entries[editIndex];
        eventInput.value = e.event || "";
        timeInput.value = e.time || "";
        dateInput.value = e.date || "";
        notesInput.value = e.notes || "";
        saveEntry.dataset.editIndex = editIndex;
    } else {
        eventInput.value = "";
        timeInput.value = "";
        dateInput.value = new Date().toISOString().slice(0, 10);
        notesInput.value = "";
        delete saveEntry.dataset.editIndex;
    }

    setTimeout(() => {
        eventInput.focus();
    }, 10);
}

function closeModal() {
    entryForm.classList.add("hidden");
    document.body.style.overflow = "";
}

addEntryBtn.onclick = () => openModal();

cancelEntry.onclick = () => closeModal();

entryForm.addEventListener("click", (e) => {
    if (e.target === entryForm.querySelector(".overlay")) {
        closeModal();
    }
});

saveEntry.onclick = () => {
    const event = document.getElementById("eventInput").value;
    const time = document.getElementById("timeInput").value.trim();
    const date = document.getElementById("dateInput").value;
    const notes = document.getElementById("notesInput").value.trim();

    if (!event || !time || !date) {
        showAutosave("Fill all required fields");
        return;
    }

    const ms = parseTimeToMs(time);
    if (ms === Infinity) {
        showAutosave("Check time format");
        return;
    }

    const editIndex = saveEntry.dataset.editIndex;
    if (editIndex !== undefined) {
        entries[Number(editIndex)] = { event, time, date, notes };
    } else {
        entries.push({ event, time, date, notes });
    }

    saveEntries();
    render();
    closeModal();
};

entriesDiv.addEventListener("click", (e) => {
    const deleteIndex = e.target.getAttribute("data-delete");
    const editIndex = e.target.getAttribute("data-edit");

    if (deleteIndex !== null) {
        const idx = Number(deleteIndex);
        if (Number.isInteger(idx) && idx >= 0 && idx < entries.length) {
            entries.splice(idx, 1);
            saveEntries();
            render();
        }
    }

    if (editIndex !== null) {
        const idx = Number(editIndex);
        if (Number.isInteger(idx) && idx >= 0 && idx < entries.length) {
            openModal(idx);
        }
    }
});

sortSelect.onchange = () => {
    render();
};

filterEvent.onchange = () => {
    render();
};

backupBtn.onclick = () => {
    const blob = new Blob([JSON.stringify(entries, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "swim_times_backup.json";
    a.click();
    showAutosave("Backup downloaded");
};

clearBtn.onclick = () => {
    const sure = confirm("Clear all saved swims from this device?");
    if (!sure) return;
    entries = [];
    saveEntries();
    render();
};

tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.dataset.tab;
        if (tab === "listTab") {
            listTab.classList.remove("hidden-section");
            statsTab.classList.remove("active");
            statsTab.classList.add("hidden-section");
        } else {
            statsTab.classList.add("active");
            statsTab.classList.remove("hidden-section");
            listTab.classList.add("hidden-section");
        }
    });
});

toggleCompact.addEventListener("click", () => {
    toggleCompact.classList.toggle("on");
    document.body.classList.toggle("compact");
    render();
});

render();
showAutosave("Saved");
</script>

</body>
</html>